<!DOCTYPE html>

<html>
<head>
  <title>MeshSlicer.jl</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="./jocco.css" />
  <script type="text/javascript"
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
</head>
<body>
  <div id="container">
    <div id="background"></div>
    <table cellpadding="0" cellspacing="0">
      <thead>
        <tr>
          <th class="docs">
            <h1>
              MeshSlicer.jl
            </h1>
          </th>
          <th class="code">
          </th>
        </tr>
      </thead>
      <tbody>

<tr id="section-1">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-1">&#182;</a>
  </div>
  
</td>
<td class="code">
<div class="highlight"><pre><span class="k">module</span> <span class="n">MeshSlicer</span>

<span class="k">using</span> <span class="n">ImmutableArrays</span>
<span class="k">using</span> <span class="n">DataStructures</span>
<span class="k">import</span> <span class="n">Base</span><span class="o">.</span><span class="n">push</span><span class="o">!</span>

<span class="k">export</span> <span class="n">Bounds</span><span class="p">,</span> <span class="n">Face</span><span class="p">,</span> <span class="n">PolygonMesh</span><span class="p">,</span> <span class="n">LineSegment</span><span class="p">,</span> <span class="n">PolygonSlice</span><span class="p">,</span>
       <span class="n">update</span><span class="o">!</span><span class="p">,</span> <span class="n">rotate</span><span class="o">!</span><span class="p">,</span> <span class="n">rotate</span>

<span class="k">type</span><span class="nc"> Bounds</span><span class="p">{</span><span class="n">T</span><span class="o">&lt;:</span><span class="n">Number</span><span class="p">}</span>
    <span class="n">xmax</span><span class="p">::</span><span class="n">T</span>
    <span class="n">ymax</span><span class="p">::</span><span class="n">T</span>
    <span class="n">zmax</span><span class="p">::</span><span class="n">T</span>
    <span class="n">xmin</span><span class="p">::</span><span class="n">T</span>
    <span class="n">ymin</span><span class="p">::</span><span class="n">T</span>
    <span class="n">zmin</span><span class="p">::</span><span class="n">T</span>
<span class="k">end</span>

<span class="k">type</span><span class="nc"> Face</span>
    <span class="n">vertices</span><span class="p">::</span><span class="n">Array</span><span class="p">{</span><span class="n">Vector3</span><span class="p">{</span><span class="kt">Float64</span><span class="p">}}</span>
    <span class="n">normal</span><span class="p">::</span><span class="n">Vector3</span><span class="p">{</span><span class="kt">Float64</span><span class="p">}</span>
<span class="k">end</span>

<span class="k">type</span><span class="nc"> PolygonMesh</span>
    <span class="n">bounds</span><span class="p">::</span><span class="n">Bounds</span>
    <span class="n">faces</span><span class="p">::</span><span class="n">LinkedList</span><span class="p">{</span><span class="n">Face</span><span class="p">}</span>
<span class="k">end</span>

<span class="k">type</span><span class="nc"> LineSegment</span>
    <span class="n">start</span><span class="p">::</span><span class="n">Vector2</span><span class="p">{</span><span class="kt">Float64</span><span class="p">}</span>
    <span class="n">finish</span><span class="p">::</span><span class="n">Vector2</span><span class="p">{</span><span class="kt">Float64</span><span class="p">}</span>
    <span class="n">normal</span><span class="p">::</span><span class="n">Vector3</span><span class="p">{</span><span class="kt">Float64</span><span class="p">}</span>
<span class="k">end</span>

<span class="k">type</span><span class="nc"> Polygon</span>
    <span class="n">segments</span><span class="p">::</span><span class="n">LinkedList</span><span class="p">{</span><span class="n">LineSegment</span><span class="p">}</span>
<span class="k">end</span>

<span class="k">type</span><span class="nc"> MeshSlice</span>
    <span class="n">polygons</span><span class="p">::</span><span class="n">Array</span><span class="p">{</span><span class="n">Polygon</span><span class="p">}</span>
    <span class="n">layer</span><span class="p">::</span><span class="kt">Float64</span>
<span class="k">end</span>

<span class="c">################################################################################</span>

</pre></div>
</td>
</tr>

<tr id="section-2">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-2">&#182;</a>
  </div>
  <p>MeshSlice</p>

</td>
<td class="code">
<div class="highlight"><pre><span class="c">################################################################################</span>

<span class="k">function</span><span class="nf"> MeshSlice</span><span class="p">(</span><span class="n">mesh</span><span class="p">::</span><span class="n">PolygonMesh</span><span class="p">,</span> <span class="n">height</span><span class="p">::</span><span class="kt">Float64</span><span class="p">)</span>

    <span class="n">segmentlist</span> <span class="o">=</span> <span class="n">LineSegment</span><span class="p">[]</span>

    <span class="k">for</span> <span class="n">face</span> <span class="k">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">faces</span>
        <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="n">extrema</span><span class="p">([</span><span class="n">face</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">e3</span> <span class="k">for</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">zmax</span>
            <span class="k">break</span>
        <span class="k">elseif</span> <span class="n">zmin</span> <span class="o">&lt;=</span> <span class="n">height</span>
            <span class="n">push</span><span class="o">!</span><span class="p">(</span><span class="n">segmentlist</span><span class="p">,</span> <span class="n">LineSegment</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
        <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">return</span> <span class="n">MeshSlice</span><span class="p">(</span><span class="n">segmentlist</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span><span class="nf"> MeshSlice</span><span class="p">(</span><span class="n">mesh</span><span class="p">::</span><span class="n">PolygonMesh</span><span class="p">,</span> <span class="n">heights</span><span class="p">::</span><span class="n">Array</span><span class="p">{</span><span class="kt">Float64</span><span class="p">})</span>

</pre></div>
</td>
</tr>

<tr id="section-3">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-3">&#182;</a>
  </div>
  <p>slice a mesh at heights given in a monotonically increasing array of heights</p>

</td>
<td class="code">
<div class="highlight"><pre>
    <span class="n">slices</span> <span class="o">=</span> <span class="n">MeshSlice</span><span class="p">[]</span>


</pre></div>
</td>
</tr>

<tr id="section-4">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-4">&#182;</a>
  </div>
  <p>Preinitialize the array</p>

</td>
<td class="code">
<div class="highlight"><pre>    <span class="k">for</span> <span class="n">height</span> <span class="k">in</span> <span class="n">heights</span>
        <span class="n">push</span><span class="o">!</span><span class="p">(</span><span class="n">slices</span><span class="p">,</span> <span class="n">PolygonSlice</span><span class="p">(</span><span class="n">LineSegment</span><span class="p">[],</span><span class="n">height</span><span class="p">))</span>
    <span class="k">end</span>

    <span class="k">for</span> <span class="n">face</span> <span class="k">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">faces</span>
        <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="n">extrema</span><span class="p">([</span><span class="n">face</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">e3</span> <span class="k">for</span> <span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">height</span> <span class="k">in</span> <span class="n">heights</span>
            <span class="k">if</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">zmax</span>
                <span class="k">break</span>
            <span class="k">elseif</span> <span class="n">zmin</span> <span class="o">&lt;=</span> <span class="n">height</span>
                <span class="n">push</span><span class="o">!</span><span class="p">(</span><span class="n">slices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">segments</span><span class="p">,</span> <span class="n">LineSegment</span><span class="p">(</span><span class="n">face</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
            <span class="k">end</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">return</span> <span class="n">slices</span>
<span class="k">end</span>


<span class="c">################################################################################</span>

</pre></div>
</td>
</tr>

<tr id="section-5">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-5">&#182;</a>
  </div>
  <p>Polygon</p>

</td>
<td class="code">
<div class="highlight"><pre><span class="c">################################################################################</span>

<span class="n">Polygon</span><span class="p">()</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">nil</span><span class="p">(</span><span class="n">LineSegment</span><span class="p">))</span>

<span class="k">function</span><span class="nf"> push</span><span class="o">!</span><span class="p">(</span><span class="n">poly</span><span class="p">::</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">f</span><span class="p">::</span><span class="n">LineSegment</span><span class="p">)</span>
    <span class="n">poly</span><span class="o">.</span><span class="n">segments</span> <span class="o">=</span> <span class="n">cons</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">poly</span><span class="o">.</span><span class="n">segments</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span><span class="nf"> Polygon</span><span class="p">(</span><span class="n">lines</span><span class="p">::</span><span class="n">Array</span><span class="p">{</span><span class="n">LineSegment</span><span class="p">})</span>
<span class="k">end</span>


<span class="c">################################################################################</span>

</pre></div>
</td>
</tr>

<tr id="section-6">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-6">&#182;</a>
  </div>
  <p>PolygonMesh</p>

</td>
<td class="code">
<div class="highlight"><pre><span class="c">################################################################################</span>

<span class="n">PolygonMesh</span><span class="p">()</span> <span class="o">=</span> <span class="n">PolygonMesh</span><span class="p">(</span><span class="n">Bounds</span><span class="p">(),</span> <span class="n">nil</span><span class="p">(</span><span class="n">Face</span><span class="p">))</span>

<span class="k">function</span><span class="nf"> PolygonMesh</span><span class="p">(</span><span class="n">path</span><span class="p">::</span><span class="n">String</span><span class="p">)</span>

</pre></div>
</td>
</tr>

<tr id="section-7">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-7">&#182;</a>
  </div>
  <p>create a mesh representation from an STL file location</p>

</td>
<td class="code">
<div class="highlight"><pre>    <span class="n">file</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>

    <span class="n">mesh</span> <span class="o">=</span> <span class="n">PolygonMesh</span><span class="p">()</span>

    <span class="k">try</span>

</pre></div>
</td>
</tr>

<tr id="section-8">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-8">&#182;</a>
  </div>
  <p>Discover file type and construct mesh STL</p>

</td>
<td class="code">
<div class="highlight"><pre>        <span class="k">if</span> <span class="n">endswith</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;.stl&quot;</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">ascii</span><span class="p">(</span><span class="n">readbytes</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>


</pre></div>
</td>
</tr>

<tr id="section-9">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-9">&#182;</a>
  </div>
  <p>ASCII STL https://en.wikipedia.org/wiki/STL_%28file_format%29#ASCII_STL</p>

</td>
<td class="code">
<div class="highlight"><pre>            <span class="k">if</span> <span class="n">lowercase</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;solid&quot;</span>
                <span class="k">while</span> <span class="o">!</span><span class="n">eof</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">lowercase</span><span class="p">(</span><span class="n">readline</span><span class="p">(</span><span class="n">file</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;facet&quot;</span>
                        <span class="n">normal</span> <span class="o">=</span> <span class="n">Vector3</span><span class="p">(</span><span class="n">float64</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]))</span>
                        <span class="n">readline</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="c"># Throw away outerloop</span>
                        <span class="n">vertices</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vector3</span><span class="p">(</span><span class="n">float64</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">readline</span><span class="p">(</span><span class="n">file</span><span class="p">))[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">readline</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="c"># throwout endloop</span>
                        <span class="n">readline</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="c"># throwout endfacet</span>
                        <span class="n">push</span><span class="o">!</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">Face</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span><span class="n">normal</span><span class="p">))</span>
                    <span class="k">end</span>
                <span class="k">end</span>


</pre></div>
</td>
</tr>

<tr id="section-10">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-10">&#182;</a>
  </div>
  <p>Binary STL https://en.wikipedia.org/wiki/STL_%28file_format%29#Binary_STL</p>

</td>
<td class="code">
<div class="highlight"><pre>            <span class="k">else</span>
                <span class="n">readbytes</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span> <span class="c"># throw out header</span>
                <span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="kt">Uint32</span><span class="p">)</span> <span class="c"># throwout triangle count</span>
                <span class="k">while</span> <span class="o">!</span><span class="n">eof</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                    <span class="n">normal</span> <span class="o">=</span> <span class="n">Vector3</span><span class="p">([</span><span class="n">float64</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="kt">Float32</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">vertices</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vector3</span><span class="p">([</span><span class="n">float64</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="kt">Float32</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">skip</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c"># throwout 16bit attribute</span>
                    <span class="n">push</span><span class="o">!</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">Face</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span><span class="n">normal</span><span class="p">))</span>
                <span class="k">end</span>
            <span class="k">end</span>
        <span class="k">end</span>

    <span class="n">finally</span>
        <span class="n">close</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">return</span> <span class="n">mesh</span>
<span class="k">end</span>

<span class="k">function</span><span class="nf"> rotate</span><span class="o">!</span><span class="p">(</span><span class="n">mesh</span><span class="p">::</span><span class="n">PolygonMesh</span><span class="p">,</span> <span class="n">angle</span><span class="p">::</span><span class="kt">Float64</span><span class="p">,</span> <span class="n">axis</span><span class="p">::</span><span class="n">Array</span><span class="p">{</span><span class="kt">Float64</span><span class="p">},</span> <span class="n">through</span><span class="p">::</span><span class="n">Array</span><span class="p">{</span><span class="kt">Float64</span><span class="p">})</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="c"># normalize axis</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">through</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">axis</span>
    <span class="k">for</span> <span class="n">face</span> <span class="k">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">faces</span>
        <span class="n">face</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="p">[</span><span class="k">begin</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">face</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                            <span class="n">rotate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>
                         <span class="k">end</span> <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">update</span><span class="o">!</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="n">face</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span><span class="nf"> rotate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>

</pre></div>
</td>
</tr>

<tr id="section-11">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-11">&#182;</a>
  </div>
  <p>See: http://inside.mines.edu/~gmurray/ArbitraryAxisRotation/#x1-10011</p>

</td>
<td class="code">
<div class="highlight"><pre>    <span class="k">return</span> <span class="n">Vector3</span><span class="p">((</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="n">w</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">u</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">v</span><span class="o">+</span><span class="n">c</span><span class="o">*</span><span class="n">w</span><span class="o">-</span><span class="n">u</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="n">v</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="n">w</span><span class="o">*</span><span class="n">z</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span><span class="o">+</span><span class="n">x</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">v</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">w</span><span class="o">-</span><span class="n">w</span><span class="o">*</span><span class="n">y</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">z</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span>
            <span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">u</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="n">w</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">v</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">u</span><span class="o">+</span><span class="n">c</span><span class="o">*</span><span class="n">w</span><span class="o">-</span><span class="n">u</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="n">v</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="n">w</span><span class="o">*</span><span class="n">z</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">u</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">w</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="n">u</span><span class="o">*</span><span class="n">z</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span>
            <span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">u</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="n">v</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">u</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">v</span><span class="o">-</span><span class="n">u</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="n">v</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="n">w</span><span class="o">*</span><span class="n">z</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span><span class="o">+</span><span class="n">z</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">u</span><span class="o">+</span><span class="n">a</span><span class="o">*</span><span class="n">v</span><span class="o">-</span><span class="n">v</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">u</span><span class="o">*</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>

<span class="k">end</span>

<span class="k">function</span><span class="nf"> push</span><span class="o">!</span><span class="p">(</span><span class="n">mesh</span><span class="p">::</span><span class="n">PolygonMesh</span><span class="p">,</span> <span class="n">f</span><span class="p">::</span><span class="n">Face</span><span class="p">)</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">faces</span> <span class="o">=</span> <span class="n">cons</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">)</span>
    <span class="n">update</span><span class="o">!</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<span class="k">end</span>

<span class="c">################################################################################</span>

</pre></div>
</td>
</tr>

<tr id="section-12">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-12">&#182;</a>
  </div>
  <p>LineSegment</p>

</td>
<td class="code">
<div class="highlight"><pre><span class="c">################################################################################</span>

<span class="k">function</span><span class="nf"> LineSegment</span><span class="p">(</span><span class="n">f</span><span class="p">::</span><span class="n">Face</span><span class="p">,</span> <span class="n">z</span><span class="p">::</span><span class="kt">Float64</span><span class="p">)</span>

    <span class="n">p0</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">p0</span><span class="o">.</span><span class="n">e3</span> <span class="o">&lt;</span> <span class="n">z</span> <span class="o">&amp;&amp;</span> <span class="n">p1</span><span class="o">.</span><span class="n">e3</span> <span class="o">&gt;=</span> <span class="n">z</span> <span class="o">&amp;&amp;</span> <span class="n">p2</span><span class="o">.</span><span class="n">e3</span> <span class="o">&gt;=</span> <span class="n">z</span>
        <span class="k">return</span> <span class="n">LineSegment</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
    <span class="k">elseif</span> <span class="n">p0</span><span class="o">.</span><span class="n">e3</span> <span class="o">&gt;</span> <span class="n">z</span> <span class="o">&amp;&amp;</span> <span class="n">p1</span><span class="o">.</span><span class="n">e3</span> <span class="o">&lt;</span> <span class="n">z</span> <span class="o">&amp;&amp;</span> <span class="n">p2</span><span class="o">.</span><span class="n">e3</span> <span class="o">&lt;</span> <span class="n">z</span>
        <span class="k">return</span> <span class="n">LineSegment</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
    <span class="k">elseif</span> <span class="n">p1</span><span class="o">.</span><span class="n">e3</span> <span class="o">&lt;</span> <span class="n">z</span> <span class="o">&amp;&amp;</span> <span class="n">p0</span><span class="o">.</span><span class="n">e3</span> <span class="o">&gt;=</span> <span class="n">z</span> <span class="o">&amp;&amp;</span> <span class="n">p2</span><span class="o">.</span><span class="n">e3</span> <span class="o">&gt;=</span> <span class="n">z</span>
        <span class="k">return</span> <span class="n">LineSegment</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
    <span class="k">elseif</span> <span class="n">p1</span><span class="o">.</span><span class="n">e3</span> <span class="o">&gt;</span> <span class="n">z</span> <span class="o">&amp;&amp;</span> <span class="n">p0</span><span class="o">.</span><span class="n">e3</span> <span class="o">&lt;</span> <span class="n">z</span> <span class="o">&amp;&amp;</span> <span class="n">p2</span><span class="o">.</span><span class="n">e3</span> <span class="o">&lt;</span> <span class="n">z</span>
        <span class="k">return</span> <span class="n">LineSegment</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
    <span class="k">elseif</span> <span class="n">p2</span><span class="o">.</span><span class="n">e3</span> <span class="o">&lt;</span> <span class="n">z</span> <span class="o">&amp;&amp;</span> <span class="n">p1</span><span class="o">.</span><span class="n">e3</span> <span class="o">&gt;=</span> <span class="n">z</span> <span class="o">&amp;&amp;</span> <span class="n">p0</span><span class="o">.</span><span class="n">e3</span> <span class="o">&gt;=</span> <span class="n">z</span>
        <span class="k">return</span> <span class="n">LineSegment</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
    <span class="k">elseif</span> <span class="n">p2</span><span class="o">.</span><span class="n">e3</span> <span class="o">&gt;</span> <span class="n">z</span> <span class="o">&amp;&amp;</span> <span class="n">p1</span><span class="o">.</span><span class="n">e3</span> <span class="o">&lt;</span> <span class="n">z</span> <span class="o">&amp;&amp;</span> <span class="n">p0</span><span class="o">.</span><span class="n">e3</span> <span class="o">&lt;</span> <span class="n">z</span>
        <span class="k">return</span> <span class="n">LineSegment</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">normal</span><span class="p">)</span>
    <span class="k">end</span>

<span class="k">end</span>

<span class="k">function</span><span class="nf"> LineSegment</span><span class="p">(</span><span class="n">p0</span><span class="p">::</span><span class="n">Vector3</span><span class="p">,</span> <span class="n">p1</span><span class="p">::</span><span class="n">Vector3</span><span class="p">,</span> <span class="n">p2</span><span class="p">::</span><span class="n">Vector3</span><span class="p">,</span> <span class="n">z</span><span class="p">::</span><span class="kt">Float64</span><span class="p">,</span> <span class="n">normal</span><span class="p">::</span><span class="n">Vector3</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">Vector2</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">e1</span> <span class="o">+</span> <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">e1</span> <span class="o">-</span> <span class="n">p0</span><span class="o">.</span><span class="n">e1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">p0</span><span class="o">.</span><span class="n">e3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">e3</span> <span class="o">-</span> <span class="n">p0</span><span class="o">.</span><span class="n">e3</span><span class="p">),</span>
                    <span class="n">p0</span><span class="o">.</span><span class="n">e2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">e2</span> <span class="o">-</span> <span class="n">p0</span><span class="o">.</span><span class="n">e2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">p0</span><span class="o">.</span><span class="n">e3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">e3</span> <span class="o">-</span> <span class="n">p0</span><span class="o">.</span><span class="n">e3</span><span class="p">))</span>
    <span class="n">finish</span> <span class="o">=</span> <span class="n">Vector2</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">e1</span> <span class="o">+</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">e1</span> <span class="o">-</span> <span class="n">p0</span><span class="o">.</span><span class="n">e1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">p0</span><span class="o">.</span><span class="n">e3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">e3</span> <span class="o">-</span> <span class="n">p0</span><span class="o">.</span><span class="n">e3</span><span class="p">),</span>
                     <span class="n">p0</span><span class="o">.</span><span class="n">e2</span> <span class="o">+</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">e2</span> <span class="o">-</span> <span class="n">p0</span><span class="o">.</span><span class="n">e2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">p0</span><span class="o">.</span><span class="n">e3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">e3</span> <span class="o">-</span> <span class="n">p0</span><span class="o">.</span><span class="n">e3</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">LineSegment</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">finish</span><span class="p">,</span> <span class="n">normal</span><span class="p">);</span>
<span class="k">end</span>


<span class="k">function</span><span class="nf"> </span><span class="o">(==)</span><span class="p">(</span><span class="n">a</span><span class="p">::</span><span class="n">LineSegment</span><span class="p">,</span> <span class="n">b</span><span class="p">::</span><span class="n">LineSegment</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">start</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">start</span> <span class="o">&amp;&amp;</span>
            <span class="n">a</span><span class="o">.</span><span class="n">finish</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">finish</span><span class="p">)</span>
<span class="k">end</span>

<span class="c">################################################################################</span>

</pre></div>
</td>
</tr>

<tr id="section-13">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-13">&#182;</a>
  </div>
  <p>Bounds</p>

</td>
<td class="code">
<div class="highlight"><pre><span class="c">################################################################################</span>

<span class="n">Bounds</span><span class="p">()</span> <span class="o">=</span> <span class="n">Bounds</span><span class="p">{</span><span class="kt">Float64</span><span class="p">}(</span><span class="o">-</span><span class="nb">Inf</span><span class="p">,</span><span class="o">-</span><span class="nb">Inf</span><span class="p">,</span><span class="o">-</span><span class="nb">Inf</span><span class="p">,</span><span class="nb">Inf</span><span class="p">,</span><span class="nb">Inf</span><span class="p">,</span><span class="nb">Inf</span><span class="p">)</span>

<span class="k">function</span><span class="nf"> update</span><span class="o">!</span><span class="p">(</span><span class="n">box</span><span class="p">::</span><span class="n">Bounds</span><span class="p">,</span> <span class="n">face</span><span class="p">::</span><span class="n">Face</span><span class="p">)</span>

</pre></div>
</td>
</tr>

<tr id="section-14">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-14">&#182;</a>
  </div>
  <p>update the bounds against a face</p>

</td>
<td class="code">
<div class="highlight"><pre>    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">extrema</span><span class="p">([</span><span class="n">face</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">e1</span> <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">extrema</span><span class="p">([</span><span class="n">face</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">e2</span> <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="n">extrema</span><span class="p">([</span><span class="n">face</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">e3</span> <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>

    <span class="n">box</span><span class="o">.</span><span class="n">xmin</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">xmin</span><span class="p">)</span>
    <span class="n">box</span><span class="o">.</span><span class="n">ymin</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">ymin</span><span class="p">)</span>
    <span class="n">box</span><span class="o">.</span><span class="n">zmin</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">zmin</span><span class="p">)</span>
    <span class="n">box</span><span class="o">.</span><span class="n">xmax</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">xmax</span><span class="p">)</span>
    <span class="n">box</span><span class="o">.</span><span class="n">ymax</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">ymax</span><span class="p">)</span>
    <span class="n">box</span><span class="o">.</span><span class="n">zmax</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">zmax</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">zmax</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span><span class="nf"> </span><span class="o">(==)</span><span class="p">(</span><span class="n">a</span><span class="p">::</span><span class="n">Bounds</span><span class="p">,</span> <span class="n">b</span><span class="p">::</span><span class="n">Bounds</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">xmax</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">xmax</span> <span class="o">&amp;&amp;</span>
            <span class="n">a</span><span class="o">.</span><span class="n">ymax</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">ymax</span> <span class="o">&amp;&amp;</span>
            <span class="n">a</span><span class="o">.</span><span class="n">zmax</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">zmax</span> <span class="o">&amp;&amp;</span>
            <span class="n">a</span><span class="o">.</span><span class="n">xmin</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">xmin</span> <span class="o">&amp;&amp;</span>
            <span class="n">a</span><span class="o">.</span><span class="n">ymin</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">ymin</span> <span class="o">&amp;&amp;</span>
            <span class="n">a</span><span class="o">.</span><span class="n">zmin</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">zmin</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">end</span> <span class="c"># module</span>


</pre></div>
</td>
</tr>

      </tbody>
    </table>
  </div>
</body>
</html>